<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="adminBoard">

	<!-- // === 페이징 처리를 안한 검색어가 있는 전체 글목록 보여주기 === -->
	<select id="boardListSearch" parameterType="HashMap" resultType="com.spring.finalproject3.seoyeon.model.AdminBoardVO">
	   	select B.seq, B.categoryno, P.name, B.subject, B.good, B.readCount, B.commentCount,to_char(B.regDate, 'yyyy-mm-dd hh24:mi:ss') as regDate
		from tbl_board B join tbl_person P
		on B.fk_perno=P.perno
		where status=1
	   <if test='searchType != "" and searchWord != "" and searchType != "total"'>
	      and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
	   </if>
	   <if test='searchWord != "" and searchType == "total"'>
	      and (lower(subject) like '%'|| lower(#{searchWord}) ||'%'
	      	or lower(content) like '%'|| lower(#{searchWord}) ||'%'
	      	)
	   </if>
	   order by seq desc
	</select>
   
	<!-- === #111. 검색어 입력시 자동글 완성하기 6 ===  -->
	<select id="wordSearchShow" parameterType="HashMap" resultType="String">
		   select ${searchType}
		   from tbl_board B join tbl_person P
		   on B.fk_perno=P.perno
		   where status = 1
		   and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
		   <if test='viewBoard != "" '>
        	and categoryno = ${viewBoard}
           </if>
		   order by seq desc
	</select>
   
   
   <select id="boardListNoSearch" resultType="com.spring.finalproject3.seoyeon.model.AdminBoardVO">
   		select B.seq, B.categoryno, P.name, B.subject, B.good, B.readCount, B.commentCount,to_char(B.regDate, 'yyyy-mm-dd hh24:mi:ss') as regDate
		from tbl_board B join tbl_person P
		on B.fk_perno=P.perno
		where status = 1
		order by seq desc
   	</select> 
   	
   	
   	<!-- === #117. 총 게시물 건수(totalCount) 구하기 - 검색이 있을때와 검색이 없을때로 나뉜다. === -->
	<select id="getTotalCount" parameterType="HashMap" resultType="int">
		select count(*)
		from tbl_board B join tbl_person P
		on B.fk_perno=P.perno
		where status = 1	
		<if test='searchWord != "" '>
        	and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
        </if>
        <if test='viewBoard != "" '>
        	and categoryno = ${viewBoard}
        </if>
	</select>
	
	<!-- === #120. 페이징 처리한 글목록 가져오기(검색이 있든지, 검색이 없든지 모두 다 포함한 것) === -->
	<select id="boardListSearchWithPaging" parameterType="HashMap" resultType="com.spring.finalproject3.seoyeon.model.AdminBoardVO">
		select seq, categoryno, name, subject, good, readCount, commentCount, regDate
		from
		(
			select row_number() over(order by seq desc) as rno,
			        B.seq, B.categoryno, P.name, B.subject, 
			        B.good, B.readCount, B.commentCount,
			        to_char(B.regDate, 'yyyy-mm-dd hh24:mi:ss') as regDate
			from tbl_board B join tbl_person P
			    on B.fk_perno=P.perno
		    where status = 1
		    <if test='searchWord != "" '>
		    and lower(${searchType}) like '%'||lower(#{searchWord})||'%'
		    </if>
		    <if test='viewBoard != "" '>
        	and categoryno = ${viewBoard}
        	</if>
		)V
		where rno between #{startRno} and #{endRno}
	</select>
	
	
	<!--  === tbl_board 테이블에 categoryno를 변경(update) === -->
	<update id="updateCommentCount" parameterType="HashMap">
		update tbl_board set categoryno = #{categoryno}
		where seq = #{seq}
	</update>
	
	
	
   
</mapper>