<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Message">

   <!--  총 게시물 건수(totalCount) 구하기  -->
   <select id="getTotalCount" parameterType="HashMap" resultType="int" >
   		select count(*)
   		from tbl_inbox
		<if test='searchWord != "" '>
         and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
      	</if>
   		order by inboxSeq desc
   </select>
   
	<!-- 페이징 처리를 한 검색어가 있는 전체 글목록 보여주기  -->
   <select id="inboxListSearchWithPaging" parameterType="HashMap" resultType="com.spring.finalproject3.hyeminJang.model.InboxVO">
   	select  inboxSeq, fk_perno, receiver, subject, reDate,  readState , inboxName
		from (
			select row_number() over (order by inboxSeq desc) as rno, 
			            inboxSeq, fk_perno, receiver, subject, 
			            to_char(reDate, 'yyyy-mm-dd PM HH:MI:SS') as reDate, readState, inboxName
			from tbl_inbox
			where receiver = to_number(#{userid})
			<if test='readState != "" '>
			and readState = 0
			</if>
			<if test='searchWord != "" '>
			and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
			</if>
		)V
		where rno between #{startRno} and #{endRno} 
		order by inboxSeq desc
   </select>
	
	<!-- 쪽지 1개 글 보기  -->
   <select id="getInView" parameterType="int" resultType="com.spring.finalproject3.hyeminJang.model.InboxVO">
		    select  inboxSeq, fk_perno, receiver, subject, inboxName,
		             to_char(reDate, 'yyyy-mm-dd PM HH:MI:SS') as reDate, readState
		    from tbl_inbox
		    where inboxSeq = #{inboxSeq}
		
   </select>
   
   <!-- // 읽은것은 1로 변환해준다. -->
   <update id="updateReadState" parameterType="int">
   		update tbl_inbox set readState = 1
		where inboxSeq = #{inboxSeq}
   </update>
   
   <!-- // 안읽은 메세지갯수세기 -->
   <select id="getNonReadCount" parameterType="int" resultType="int">
   		select count(*)
   		from tbl_inbox
   		where readState = 0 and fk_perno = #{userid} 
   </select>
   
   <!-- // inbox에서 체크박스에서 선택된 쪽지  삭제하기  -->
   <delete id="inDel"  parameterType="int" >
   		delete tbl_inbox
   		where inboxSeq = #{deleteSeq}
   </delete>
   
   <select id="searchPerson" parameterType="int" resultType="com.spring.finalproject3.joseungjin.model.PersonVO">
   		select perno, name, fk_majseq, identity, pwd
   		from tbl_person
   		where perno = #{parseInt} 
   </select>
   
   <select id="getNameMaj" parameterType="int" resultType="String">
   		select content
   		from tbl_major
   		where majseq = #{majseq} 
   </select>

	<insert id="insertInbox" parameterType="HashMap">
		insert into tbl_inbox(inboxSeq, fk_perno, receiver, subject, reDate, readState, inboxName)
		values(seq_tbl_inbox_inboxSeq.nextval,   #{login_userid},  #{receiver},  #{text},  default, default, #{name})
	</insert>
	
	<insert id="insertOutbox" parameterType="HashMap">
		insert into tbl_outbox(outboxSeq, fk_perno, sender, subject, senDate, readState, outboxName)
		values(seq_tbl_outbox_outboxSeq.nextval,   #{receiver}, #{login_userid} ,  #{text},  default, default, #{name})
	</insert>
	

</mapper>